<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>InAppPurchase - Tech Blog</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "InAppPurchase";
        var mkdocs_page_input_path = "ios/ios-inapp-purchase-usage.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Tech Blog
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">News</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../about/">About</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Go</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../go/go-develop-env/">Develop Env</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Grammar</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../go/go-grammar/">API</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Features</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../go/go-grammar/">Go GC</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Library</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../go/go-google-api-usage/">Google API</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">iOS</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="#">Grammar</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../ios-grammar/">Swift</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Features</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../ios-grammar/">Swift ARC</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Library</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../afnetworking-usage/">AfNetworking</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">InAppPurchase</a>
    <ul class="current">
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../app-with-framework/">Create Framework</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cocoapod-usage/">Cocoapod Usage</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cocoapods-private/">Cocoapod Private</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cocoapods-public/">Cocoapod Public</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ios_exclude_simulator_architecture/">Exclude Architecture</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ios-serviceID-setting/">ServiceID Setting</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../use_frameworks_definition/">Framework Definition</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Android</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">Grammar</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../android/android-grammar/">Kotlin</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Features</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../android/android-grammar/">Swift ARC</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../android/android-package-refactor/">PackagenameRefactor</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Library</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../android/acra-usage/">ACRA</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../android/android-google-billing-usage/">GoogleBilling</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../android/android-onestore-billing-usage/">OneStoreBilling</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../android/create-library/">Create Module</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../android/gson/">Gson</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../android/retrofit2/">Retrofit2</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../android/android-appleLogin/">AppleLogin</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Gradle</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../android/maven-deploy/">Maven</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../android/jcenter/">Jcenter</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Unity</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">Grammar</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../unity/c%23-grammar/">C#</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../unity/unity-api/">API</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Features</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../unity/gradle-version-manage/">Android Gradle</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../unity/unity2017-androidx-use/">AndroidX Use</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../unity/unity_xcode_AddInAppPurchase/">iOS Capability</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../unity/unity-ios-application-override/">iOS Application Override</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Library</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../unity/unity-api/">Asset</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Editor</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../unity/unity-build-machine-shell/">Build Machine</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Docker</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../docker/docker-build-deploy/">Build Deploy</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Shell</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../android/gpg-usage/">GPG Key</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Tech Blog</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>iOS &raquo;</li>
          <li>Library &raquo;</li>
      <li>InAppPurchase</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p>apple Developer console 에 앱 등록이 되어 있다는 가정하에 설명한다.</p>
<p>우선 인앱상품등록 부터 준비한다. (앱 업로드는 하지 않아도 샌드박스 결제테스트가 가능하다.)</p>
<h2 id="_1">인앱 상품 등록<a class="headerlink" href="#_1" title="Permanent link">#</a></h2>
<ul>
<li>소스코드단에서 제품 ID 를 사용하기 때문에 잘 정해주면 된다.</li>
<li>나머지는 수정이 가능하나 제품 ID 는 변경이 안된다.</li>
<li>등록된 상품은 수정 및 삭제가 가능하다.</li>
<li>상품이 등록되었다면 앱 업로드 또는 출시를 하지 않아도 결제테스트 준비가 끝난 것이다.</li>
</ul>
<p><img alt="inapp register" src="https://user-images.githubusercontent.com/20632507/108959794-41818780-76b8-11eb-9b00-ec904ad07bba.png" /></p>
<p><img alt="inapp regist" src="https://user-images.githubusercontent.com/20632507/108959807-48a89580-76b8-11eb-8335-a23b43f91600.png" /></p>
<h2 id="_2">샌드박스 테스터 추가<a class="headerlink" href="#_2" title="Permanent link">#</a></h2>
<ul>
<li>샌드박스 결제테스트를 위해 테스터 계정을 추가한다.</li>
<li>App Store Connect &gt; 사용자 및 액서스 &gt; Sandbox &gt; 테스터 &gt; 신규 사용자 등록</li>
<li>이메일은 애플계정에 등록되지 않은 이메일주소여야 한다.</li>
</ul>
<h2 id="_3">인앱 결제 기능 활성화<a class="headerlink" href="#_3" title="Permanent link">#</a></h2>
<ul>
<li>프로젝트 Targets &gt; Signing &amp; Capabilities 탭에 가면 + Capability 버튼 클릭</li>
<li>In-App Purchase 활성화를 시켜주면 자동으로 Storekit 라이브러리도 포함된다.</li>
</ul>
<p>여기까지 인앱결제 개발을 위한 준비가 끝났다.</p>
<h2 id="_4">코드 구현<a class="headerlink" href="#_4" title="Permanent link">#</a></h2>
<ul>
<li>setupBilling 에 NSArray (상품ID 목록) 을 넣어주면 인앱결제 모듈이 초기화된다.</li>
<li>결제가 완료된 후에는 따로 델레게이트나 block 으로 콜백을 만들어서 사용하면 된다.</li>
</ul>
<p>BillingManager.h</p>
<pre><code class="language-objective-c">#import &lt;Foundation/Foundation.h&gt;
#import &lt;StoreKit/StoreKit.h&gt;

NS_ASSUME_NONNULL_BEGIN

@interface BillingManager : NSObject&lt;SKProductsRequestDelegate,SKPaymentTransactionObserver&gt;
{
    NSString *productID;
}

+ (instancetype)getInstance;

@property (nonatomic) NSArray *productList;

- (void)setupBilling:(NSArray*)arr;
- (void)purchase:(NSString*)pid;
- (BOOL)canMakePurchases;
- (float)getPrice:(NSString*)pid;
- (NSString*)getPriceCurrencyCode:(NSString*)pid;
- (SKProduct*)getSKProduct:(NSString*)pid;

@end

NS_ASSUME_NONNULL_END
</code></pre>
<p>BillingManager.m</p>
<pre><code class="language-objective-c">#import &quot;BillingManager.h&quot;

@implementation BillingManager

+ (instancetype)getInstance {
    static BillingManager *shared = nil;

    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        shared = [[BillingManager alloc] init];
    });
    return shared;
}

- (void)setupBilling:(NSArray *)arr
{
    _productList = arr;

    NSMutableArray* tempArr = [NSMutableArray array];
    for(RespAppInApp *item in _productList)
    {
        [tempArr addObject:item.ProductID];
    }

    NSSet *productIdentifiers = [NSSet setWithArray:tempArr];
    SKProductsRequest *productsRequest = [[SKProductsRequest alloc] initWithProductIdentifiers:productIdentifiers];
    productsRequest.delegate = self;
    [productsRequest start];
}

- (float)getPrice:(NSString *)pid
{
    for(SKProduct *skProduct in _productList)
    {
        if ([skProduct.productIdentifier isEqualToString:pid])
        {
            return [skProduct.price floatValue];
        }
    }
    return 0;
}

- (NSString*)getPriceCurrencyCode:(NSString *)pid
{
    for(SKProduct *skProduct in _productList)
    {
        if ([skProduct.productIdentifier isEqualToString:pid])
        {
            return skProduct.priceLocale.currencyCode;
        }
    }
    return @&quot;&quot;;
}

- (SKProduct*)getSKProduct:(NSString *)pid
{
    for(SKProduct *item in _productList)
    {
        if([item.productIdentifier isEqualToString:pid] == YES)
            return item;
    }
    return nil;
}

- (BOOL)canMakePurchases {
    return [SKPaymentQueue canMakePayments];
}

- (void)purchase:(NSString *)pid
{
    productID = pid;
    if (_productList != nil)
    {
        if ([self canMakePurchases])
        {
            SKProduct *skProduct = [self getSKProduct:pid];
            if(skProduct != nil)
            {
                SKPayment *skPayment = [SKPayment paymentWithProduct:skProduct];
                [[SKPaymentQueue defaultQueue] addTransactionObserver:self];
                [[SKPaymentQueue defaultQueue] addPayment:skPayment];
            }else{
                NSLog(@&quot;Product is null&quot;);
            }
        } else {
            NSLog(@&quot;No Purchases&quot;);
        }
    }
}

- (NSString *)getReceiptCode
{
    NSURL *receiptURL = [[NSBundle mainBundle] appStoreReceiptURL];
    NSData *receipt = [NSData dataWithContentsOfURL:receiptURL];

    if (!receipt) {
        NSLog(@&quot;no receipt&quot;);
        return nil;
    } else {
        // Get the receipt in encoded format
        NSString *encodedReceipt = [receipt base64EncodedStringWithOptions:0];

        return encodedReceipt;
    }
}

#pragma mark - StoreKit Delegate
- (void)paymentQueue:(nonnull SKPaymentQueue *)queue updatedTransactions:(nonnull NSArray&lt;SKPaymentTransaction *&gt; *)transactions {

    for (SKPaymentTransaction *transaction in transactions) {
        switch (transaction.transactionState) {
            case SKPaymentTransactionStatePurchasing:
                NSLog(@&quot;Purchasing&quot;);
                break;

            case SKPaymentTransactionStatePurchased:
                {
                    long long milliseconds = (long long)(transaction.transactionDate.timeIntervalSince1970 * 1000.0);
                    NSString *purchaseTime = [NSString stringWithFormat:@&quot;%lld&quot;, milliseconds];
                    NSLog(@&quot;%lld&quot;, milliseconds);
                    NSLog(@&quot;purchaseTime : %@&quot;, purchaseTime);
                    NSLog(@&quot;transactionIdentifier : %@&quot;, transaction.transactionIdentifier);
                    NSLog(@&quot;productIdentifier : %@&quot;, transaction.payment.productIdentifier);
                    NSLog(@&quot;quantity : %@&quot;, [@(transaction.payment.quantity) stringValue]);
                    NSLog(@&quot;getReceiptCode : %@&quot;, [self getReceiptCode]);
                    NSLog(@&quot;Purchase completed&quot;);                    

                    [[SKPaymentQueue defaultQueue] finishTransaction:transaction];
                }
                break;

            case SKPaymentTransactionStateRestored:
                NSLog(@&quot;Restored&quot;);
                [[SKPaymentQueue defaultQueue] finishTransaction:transaction];
                break;

            case SKPaymentTransactionStateFailed:
                NSLog(@&quot;Purchase failed %@&quot;, transaction.error);
                //[[SKPaymentQueue defaultQueue] finishTransaction:transaction];
                break;

            case SKPaymentTransactionStateDeferred:
            {
                break;
            }

            default:
                break;
        }
    }
}

- (void)productsRequest:(SKProductsRequest *)request didReceiveResponse:(SKProductsResponse *)response
{
    NSUInteger count = [response.products count];

    if (count &gt; 0) {
        _productList = response.products;

        for(SKProduct *skProduct in _productList)
        {
            NSLog(@&quot;Found product: %@ – Product: %@ – Price: %0.2f&quot;, skProduct.productIdentifier, skProduct.localizedTitle, skProduct.price.floatValue);
        }
    } else {
        NSLog(@&quot;No product or complete contract and tax financial transaction items.&quot;);
    }
}

@end
</code></pre>
<h2 id="_5">영수증 검증<a class="headerlink" href="#_5" title="Permanent link">#</a></h2>
<ul>
<li>서버가 없다면 클라이언트에서 구현해도 된다.</li>
<li>클라나 서버 둘중 한군데서 처리하면 되고 방식은 동일하다.</li>
<li>결제처리가 완료된 후 호출</li>
<li>검증url은 샌드박스용 앱스토어용 두가지가 있다.</li>
</ul>
<pre><code class="language-objective-c">-(void)verifyReceipt
{
    NSURL *receiptURL = [[NSBundle mainBundle] appStoreReceiptURL];
    NSData *receipt = [NSData dataWithContentsOfURL:receiptURL];
    if (!receipt) {
        NSLog(@&quot;no receipt info&quot;);
    }

    // Create the JSON object that describes the request
    NSError *error;
    NSDictionary *requestContents = @{
        @&quot;receipt-data&quot;: [receipt base64EncodedStringWithOptions:0]
    };
    NSData *requestData = [NSJSONSerialization dataWithJSONObject:requestContents
                                                          options:0
                                                            error:&amp;error];

    if (!requestData) {
        NSLog(@&quot;%@&quot;, error);
    }

    // Create a POST request with the receipt data.
    // https://sandbox.itunes.apple.com/verifyReceipt , https://buy.itunes.apple.com/verifyReceipt
    NSURL *storeURL = [NSURL URLWithString:@&quot;https://sandbox.itunes.apple.com/verifyReceipt&quot;];
    NSMutableURLRequest *storeRequest = [NSMutableURLRequest requestWithURL:storeURL];
    [storeRequest setHTTPMethod:@&quot;POST&quot;];
    [storeRequest setHTTPBody:requestData];

    [[NSURLSession sharedSession] dataTaskWithRequest:storeRequest
                                     completionHandler:^(NSData * _Nullable data,
                                                         NSURLResponse * _Nullable response,
                                                         NSError * _Nullable error)
    {
        if(error)
        {
            NSLog(@&quot;%@&quot;, error);
        }else{
            NSError *error;
            NSDictionary *respDict = [NSJSONSerialization JSONObjectWithData:data options:0 error:&amp;error];
            if (!respDict) {
                NSLog(@&quot;%@&quot;, error);
            }
            NSLog(@&quot;%@&quot;, respDict);
        }
    }];
}
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../afnetworking-usage/" class="btn btn-neutral float-left" title="AfNetworking"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../app-with-framework/" class="btn btn-neutral float-right" title="Create Framework">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../afnetworking-usage/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../app-with-framework/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
